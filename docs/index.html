<!DOCTYPE html>
<html>
    <head>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes" /> 
    <meta name="viewport" content="width=device-width, initial-scale=0.5, maximum-scale=0.5, user-scalable=no">
    <link rel="preload" href="//db.onlinewebfonts.com/t/a082fd3df68a0b54e0d4d794bc38d268.woff2" as="font" type="font/woff2" crossorigin>
    <style>
    @font-face {
        font-family: "Blender Pro";
        src: url("//db.onlinewebfonts.com/t/a082fd3df68a0b54e0d4d794bc38d268.woff2") format("woff2"),
            url("//db.onlinewebfonts.com/t/a082fd3df68a0b54e0d4d794bc38d268.woff") format("woff"),
            url("//db.onlinewebfonts.com/t/a082fd3df68a0b54e0d4d794bc38d268.eot?#iefix") format("embedded-opentype"),
            url("//db.onlinewebfonts.com/t/a082fd3df68a0b54e0d4d794bc38d268.ttf") format("truetype"),
            url("//db.onlinewebfonts.com/t/a082fd3df68a0b54e0d4d794bc38d268.svg#Blender Pro") format("svg"); 
        }
        canvas {
            padding: 0;
            margin: auto;
            display: block;
        }
    </style>
    </head>

    <body bgcolor="#ffffff">
        <canvas id="card">
            Your browser does not support the HTML5 canvas tag.
        </canvas>
        <br />

        <script type="text/javascript" src="images.js"></script>
        <script type="text/javascript" src="lacerda.js"></script>
        <script>
            var lacerda = new Lacerda();
            var img_ratio;

            function refresh_canvas() {
                console.debug("refreshing canvas");

                var c = document.getElementById("card");
                var ctx = c.getContext("2d");
                ctx.fillStyle = "white";
                // OK, this next line is hacky af, but simple, and works...
                ctx.font = 42 * (c.width / background.width) + "px Blender Pro";
                ctx.drawImage(background, 0, 0, c.width, c.height);

                var state = lacerda.currentState();

                if (state == null) {
                    var txtInstruction = "Click to draw, refresh to restart!";
                    var m = ctx.measureText(txtInstruction);
                    ctx.fillText(txtInstruction, c.width/2-m.width/2, 0.96*c.height);
                } else {
                    var txtRoundLabel = "ROUND " + lacerda.currentRound;
                    ctx.fillText(txtRoundLabel, 0.75*c.width, 0.96*c.height);

                    ctx.drawImage(actions[state.action-1], 0, 0, c.width, c.height);
                    ctx.drawImage(hex_tiebreakers[state.hexTiebreaker], 0, 0, c.width, c.height);
                    if (state.mission != null) {
                        ctx.drawImage(missions[state.mission], 0, 0, c.width, c.height);
                    }

                    ctx.fillStyle = "black";
                    ctx.font = 40 * (c.width / background.width) + "px Blender Pro";
                    ctx.fillText("RND4: " + (state.techTiebreaker+1), 0.05*c.width, 0.80*c.height);
                    ctx.fillText("RND6: " + (state.contractTiebreaker+1), 0.05*c.width, 0.82*c.height);

                    if (state.turnOrders != null) {
                        ctx.font = 80 * (c.width / background.width) + "px Blender Pro";
                        ctx.fillText(">", 0.66*c.width, 0.82*c.height);
                    }
                }
            }
            
            window.onresize = function() {
                console.debug("resizing window");

                var c = document.getElementById("card");

                img_ratio = background.width / background.height;
                w = 0.98 * window.innerWidth;
                h = 0.98 * window.innerHeight;
                if (w/h <= img_ratio) {
                    c.width = w;
                    c.height = w / img_ratio;
                } else {
                    c.width = h * img_ratio;
                    c.height = h;
                }
                refresh_canvas();
            }

            window.onload = function() {
                var c = document.getElementById("card");
                c.onclick = function() {
                    switch (lacerda.currentPhase) {
                        case "shuttle":
                            lacerda.currentPhase = "colonisation";
                            var s = lacerda.currentState();

                            var ctx = c.getContext("2d");
                            ctx.drawImage(turnorder, 0, 0, c.width, c.height);
                            ctx.drawImage(primary_turnorders[s.turnOrders[0]], 0, 0, c.width, c.height);
                            ctx.drawImage(secondary_turnorders[s.turnOrders[1]], 0, 0, c.width, c.height);
                            break;
                        case "colonisation":
                            var s = lacerda.nextState();
                            console.debug(s);
                            refresh_canvas();
                            if (s.turnOrders != null) {
                                lacerda.currentPhase = "shuttle";
                            }

                            if (lacerda.currentRound == 42) {
                                alert("Congrats! You've just reached the Answer to the Ultimate Question of Life, the Universe, and Everything!");
                            }
                            break;
                    }
                }

                window.onresize();
            }
        </script>

</body>
</html>

